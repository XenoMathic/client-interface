<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interface Client Animée</title>
  <style>
    :root {
      --primary: #0069d9;
      --accent: #ff6f61;
      --background: #f0f4f8;
      --card-bg: #ffffff;
      --border: #d1e3f0;
      --text: #1f2d3d;
      --radius: 12px;
      --spacing: 1rem;
      --shadow: 0 4px 16px rgba(0,0,0,0.1);
      --transition-speed: 0.3s;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--background); font-family: 'Segoe UI', Arial, sans-serif; color: var(--text); overflow-x: hidden; }
    .container { width: 90%; max-width: 900px; margin: 2rem auto; background: var(--card-bg); padding: var(--spacing); border-radius: var(--radius); box-shadow: var(--shadow); }
    h2, h3 { text-align: center; color: var(--primary); margin-bottom: var(--spacing); }

    /* Welcome Overlay & Confetti */
    #welcomeOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; opacity:0; visibility:hidden; transition:opacity 0.5s; z-index:100; overflow:hidden; }
    #welcomeOverlay.show { opacity:1; visibility:visible; }
    #welcomeMessage { font-size:2.5rem; color:#fff; text-shadow:0 0 10px rgba(0,0,0,0.5); animation: bounceIn 0.8s forwards; }
    @keyframes bounceIn { 0% { transform: scale(0.5); opacity:0; } 60% { transform: scale(1.2); opacity:1; } 100% { transform: scale(1); opacity:1; } }
    .confetti { position:absolute; width:8px; height:8px; opacity:0.8; animation: fall linear forwards; }
    @keyframes fall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(100vh) rotate(360deg); } }

    /* Tabs & Content */
    .tabs { display:flex; position:relative; margin-bottom:var(--spacing); }
    .indicator { position:absolute; bottom:0; left:0; height:3px; background:var(--accent); width:calc(100% / 4); transition:transform var(--transition-speed) ease; border-radius:var(--radius) var(--radius) 0 0; }
    .tab { flex:1; text-align:center; padding:var(--spacing); cursor:pointer; background:var(--card-bg); border:1px solid var(--border); border-bottom:none; border-radius:var(--radius) var(--radius) 0 0; transition:background var(--transition-speed), color var(--transition-speed); }
    .tab.active, .tab:hover { background:var(--primary); color:#fff; }
    .content-section { display:none; border:1px solid var(--border); border-radius:0 0 var(--radius) var(--radius); background:var(--card-bg); padding:var(--spacing); animation:fadeInSlide var(--transition-speed) ease-in; }
    .content-section.active { display:block; }
    @keyframes fadeInSlide { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    /* Forms & Buttons */
    form input, textarea { width:100%; padding:0.75rem; border:1px solid var(--border); border-radius:var(--radius); margin-bottom:var(--spacing); font-size:1rem; transition:border-color var(--transition-speed); }
    form input:focus, textarea:focus { border-color:var(--primary); outline:none; }
    button, .action, .paste, .copy-id { padding:0.75rem 1rem; border:none; border-radius:var(--radius); cursor:pointer; color:#fff; font-weight:600; transition:transform var(--transition-speed), box-shadow var(--transition-speed); }
    .action, form button { background:var(--accent); }
    .paste { background:#28a745; }
    .copy-id { background:#17a2b8; }
    button:hover, .action:hover, .paste:hover, .copy-id:hover { transform: translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,0.15); }

    /* Cards */
    .card { background:var(--card-bg); padding:var(--spacing); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:var(--spacing); opacity:0; animation:cardPop 0.5s forwards ease-in; }
    @keyframes cardPop { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
    .card:hover { box-shadow:0 12px 32px rgba(0,0,0,0.2); }
    ul.prescription { list-style:disc inside; margin-top:var(--spacing); padding-left:1rem; }
    #mapEmbed { width:100%; height:300px; border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; margin-top:var(--spacing); animation:fadeInSlide var(--transition-speed) ease-in; }
  </style>
</head>
<body>
  <!-- Welcome Overlay -->
  <div id="welcomeOverlay">
    <div id="welcomeMessage">Bienvenue dans <span style="color:var(--accent)">PharmaGO</span>!</div>
  </div>

  <!-- Auth Container -->
  <div id="auth" class="container">
    <h2 id="authTitle">Connexion</h2>
    <form id="loginForm">
      <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" required>
      <input type="password" id="loginPassword" placeholder="Mot de passe" required>
      <button type="submit">Se connecter</button>
    </form>
    <form id="registerForm" style="display:none;">
      <input type="text" id="regUsername" placeholder="Nom d'utilisateur" required>
      <input type="password" id="regPassword" placeholder="Mot de passe" required>
      <button type="submit">Créer un compte</button>
    </form>
    <a id="toggleAuth" style="display:block; text-align:center; color:var(--primary); margin-top:var(--spacing); cursor:pointer;">Créer un compte</a>
  </div>

  <!-- App Container -->
  <div id="app" class="container" style="display:none;">
    <h2>Bienvenue, <span id="displayUsername"></span>!</h2>
    <div class="tabs">
      <div class="indicator"></div>
      <div class="tab active" data-target="profile">Profil</div>
      <div class="tab" data-target="ordonnance">Décodage</div>
      <div class="tab" data-target="pharmacie">Pharmacie</div>
      <div class="tab" data-target="logout">Déconnexion</div>
    </div>
    <div id="profile" class="content-section active">
      <h3>Mes Ordonnances</h3>
      <div id="profileOrdos"></div>
    </div>
    <div id="ordonnance" class="content-section">
      <h3>Décoder une ordonnance</h3>
      <textarea id="codeInput" placeholder="Collez le code ici..." required></textarea>
      <div id="hiddenCode" style="display:none;"></div>
      <div style="display:flex; gap:0.5rem; margin-bottom:var(--spacing);">
        <button id="pasteBtn" class="paste">Coller</button>
        <button id="showBtn" class="action" disabled>Afficher</button>
      </div>
      <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:var(--spacing);">
        <strong>ID :</strong> <span id="displayID"></span>
        <button id="copyID" class="copy-id" style="display:none;">Copier ID</button>
      </div>
      <div id="codeResult"></div>
    </div>
    <div id="pharmacie" class="content-section">
      <h3>Pharmacie la plus proche</h3>
      <button id="locatePharmacy" class="action">Afficher carte</button>
      <div id="mapEmbed"></div>
    </div>
    <div id="logout" class="content-section">
      <h3>Déconnexion</h3>
      <button id="logoutBtn" class="action">Se déconnecter</button>
    </div>
  </div>

  <script>
    // Toggle auth forms
    const authDiv = document.getElementById('auth');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const toggleLink = document.getElementById('toggleAuth');
    let isLogin = true;
    toggleLink.addEventListener('click', () => {
      isLogin = !isLogin;
      loginForm.style.display = isLogin ? 'block' : 'none';
      registerForm.style.display = isLogin ? 'none' : 'block';
      toggleLink.textContent = isLogin ? 'Créer un compte' : 'Se connecter';
    });

    // Confetti generation
    function launchConfetti() {
      const count = 100;
      const colors = ['#ff6f61','#0069d9','#28a745','#ffc107'];
      const overlay = document.getElementById('welcomeOverlay');
      for (let i = 0; i < count; i++) {
        const conf = document.createElement('div'); conf.classList.add('confetti');
        const size = Math.random() * 8 + 4;
        conf.style.width = conf.style.height = size + 'px';
        conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        conf.style.left = Math.random() * window.innerWidth + 'px';
        conf.style.animationDuration = Math.random() * 2 + 3 + 's';
        conf.style.animationDelay = Math.random() * 0.5 + 's';
        overlay.appendChild(conf);
        conf.addEventListener('animationend', () => conf.remove());
      }
    }

    // Show welcome then start app
    function showWelcome(callback) {
      const overlay = document.getElementById('welcomeOverlay');
      overlay.classList.add('show'); launchConfetti();
      setTimeout(() => { overlay.classList.remove('show'); callback(); }, 3000);
    }

    // Register logic with validation
    registerForm.addEventListener('submit', e => {
      e.preventDefault();
      const u = document.getElementById('regUsername').value.trim();
      const pw = document.getElementById('regPassword').value;
      if (!u || !pw) return alert('Tous les champs sont requis');
      if (localStorage.getItem('user_' + u)) return alert('Nom déjà pris');
      localStorage.setItem('user_' + u, JSON.stringify({ password: pw }));
      localStorage.setItem('ordonnances_' + u, JSON.stringify([]));
      showWelcome(() => startApp(u));
    });

    // Login logic with password verification
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const u = document.getElementById('loginUsername').value.trim();
      const pw = document.getElementById('loginPassword').value;
      if (!u || !pw) return alert('Tous les champs sont requis');
      const stored = JSON.parse(localStorage.getItem('user_' + u) || 'null');
      if (!stored || stored.password !== pw) return alert('Utilisateur ou mot de passe incorrect');
      showWelcome(() => startApp(u));
    });

    // Startup
    function startApp(u) {
      window.currentUser = u;
      authDiv.style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('displayUsername').textContent = u;
      initTabs(); initDecoding(); loadProfileOrdos();
    }

    // Profile ordonnances
    function saveOrdos(list) { localStorage.setItem('ordonnances_' + window.currentUser, JSON.stringify(list)); }
    function loadProfileOrdos() {
      const div = document.getElementById('profileOrdos'); div.innerHTML = '';
      const list = JSON.parse(localStorage.getItem('ordonnances_' + window.currentUser) || '[]');
      list.forEach((ord, i) => {
        const card = document.createElement('div'); card.className = 'card';
        let html = `<h4>#${i+1} - ${ord.date}</h4><p><strong>ID :</strong> ${ord.id}</p><p><strong>Patient :</strong> ${ord.patient}</p><ul class="prescription">`;
        ord.prescription.forEach(item => html += `<li>${item.medicament} (${item.nomCommercial}) - ${item.frequence}x/j pendant ${item.duree}j</li>`);
        html += '</ul>';
        card.innerHTML = html;
        const del = document.createElement('button'); del.className = 'action'; del.textContent = 'Supprimer';
        del.addEventListener('click', () => { list.splice(i,1); saveOrdos(list); loadProfileOrdos(); });
        card.append(del);
        div.append(card);
      });
    }

    // Tabs logic
    function initTabs() {
      const tabs = document.querySelectorAll('.tab'); const indicator = document.querySelector('.indicator');
      tabs.forEach((tab, idx) => tab.addEventListener('click', () => {
        if (tab.dataset.target === 'logout') return location.reload();
        tabs.forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        tab.classList.add('active'); document.getElementById(tab.dataset.target).classList.add('active');
        indicator.style.transform = `translateX(${idx * 100}%)`;
      }));
      indicator.style.transform = 'translateX(0)';
    }

    // Decoding logic
    function initDecoding() {
      const pasteBtn = document.getElementById('pasteBtn');
      const showBtn = document.getElementById('showBtn');
      const hiddenDiv = document.getElementById('hiddenCode');
      const displayID = document.getElementById('displayID');
      const codeInput = document.getElementById('codeInput');
      const codeResult = document.getElementById('codeResult');

      pasteBtn.addEventListener('click', async () => {
        try {
          const t = (await navigator.clipboard.readText()).trim();
          hiddenDiv.textContent = t;
          const id = t.slice(0,12);
          codeInput.value = id;
          displayID.textContent = id;
          document.getElementById('copyID').style.display = 'inline-block';
          showBtn.disabled = false;
        } catch {
          alert('Impossible de coller');
        }
      });

      document.getElementById('copyID').addEventListener('click', () => navigator.clipboard.writeText(displayID.textContent));

      showBtn.addEventListener('click', () => {
        try {
          const full = hiddenDiv.textContent;
          const data = full.slice(12);
          const ord = JSON.parse(atob(data));
          ord.id = full.slice(0,12);
          const list = JSON.parse(localStorage.getItem('ordonnances_' + window.currentUser) || '[]');
          list.push(ord); saveOrdos(list); loadProfileOrdos();

          codeResult.innerHTML = '';
          const card = document.createElement('div'); card.className = 'card';
          let html = `<h4>Ordonnance du ${ord.date}</h4><p><strong>Patient :</strong> ${ord.patient}</p><ul class="prescription">`;
          ord.prescription.forEach(item => html += `<li>${item.medicament} (${item.nomCommercial}) - ${item.frequence}x/j pendant ${item.duree}j</li>`);
          html += '</ul>';
          card.innerHTML = html; codeResult.append(card);
          showBtn.disabled = true;
        } catch {
          alert('Code invalide');
        }
      });
    }

    // Pharmacie logic
    document.getElementById('locatePharmacy').addEventListener('click', () => {
      const mapDiv = document.getElementById('mapEmbed'); mapDiv.innerHTML = '';
      if (!navigator.geolocation) return mapDiv.textContent = 'Géolocalisation non supportée.';
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const iframe = document.createElement('iframe');
        iframe.src = `https://maps.google.com/maps?q=pharmacie&ll=${latitude},${longitude}&z=15&output=embed`;
        iframe.style.width = '100%'; iframe.style.height = '100%'; iframe.style.border='0';
        mapDiv.appendChild(iframe);
      }, () => mapDiv.textContent = 'Localisation impossible.');
    });
  </script>
</body>
</html>